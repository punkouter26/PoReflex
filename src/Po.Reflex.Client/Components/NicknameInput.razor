@* NicknameInput Component with Real-time Validation (FR-014, FR-015) *@
@using System.Text.RegularExpressions

<div class="nickname-input-wrapper">
    <input type="text"
           class="nickname-input @(hasError ? "error" : "")"
           placeholder="Enter nickname (3-20 chars)"
           value="@Value"
           @oninput="HandleInput"
           @onblur="ValidateOnBlur"
           maxlength="20"
           data-testid="nickname-input" />
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="validation-error" data-testid="nickname-error">@errorMessage</p>
    }
</div>

@code {
    [Parameter]
    public string Value { get; set; } = "";

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    [Parameter]
    public EventCallback<bool> OnValidChanged { get; set; }

    private string errorMessage = "";
    private bool hasError = false;
    private bool touched = false;

    private const int MinLength = 3;
    private const int MaxLength = 20;
    private static readonly Regex ValidPattern = new(@"^[A-Za-z0-9_]*$", RegexOptions.Compiled);

    private async Task HandleInput(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? "";
        
        // Remove invalid characters as typed
        newValue = Regex.Replace(newValue, @"[^A-Za-z0-9_]", "");
        
        // Truncate to max length
        if (newValue.Length > MaxLength)
        {
            newValue = newValue[..MaxLength];
        }

        Value = newValue;
        await ValueChanged.InvokeAsync(Value);
        
        // Validate in real-time after user starts typing
        if (touched || newValue.Length > 0)
        {
            touched = true;
            await ValidateAsync();
        }
    }

    private async Task ValidateOnBlur()
    {
        touched = true;
        await ValidateAsync();
    }

    private async Task ValidateAsync()
    {
        var isValid = ValidateNickname(out var error);
        errorMessage = error;
        hasError = !isValid && touched;
        
        await OnValidChanged.InvokeAsync(isValid);
    }

    private bool ValidateNickname(out string error)
    {
        error = "";

        if (string.IsNullOrWhiteSpace(Value))
        {
            error = "Nickname is required";
            return false;
        }

        if (Value.Length < MinLength)
        {
            error = $"Nickname must be at least {MinLength} characters";
            return false;
        }

        if (Value.Length > MaxLength)
        {
            error = $"Nickname must be at most {MaxLength} characters";
            return false;
        }

        if (!ValidPattern.IsMatch(Value))
        {
            error = "Nickname can only contain letters, numbers, and underscores";
            return false;
        }

        return true;
    }

    public bool IsValid => ValidateNickname(out _);
}
