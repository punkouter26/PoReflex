@* Leaderboard Component with Daily/All-Time Toggle (FR-021, FR-022, FR-023) *@
@inject HttpClient Http
@using Po.Reflex.Shared.DTOs

<div class="leaderboard" data-testid="leaderboard">
    <div class="leaderboard-toggle">
        <button class="toggle-btn @(showDaily ? "active" : "")" @onclick="ShowDaily" data-testid="daily-tab">Daily</button>
        <button class="toggle-btn @(!showDaily ? "active" : "")" @onclick="ShowAllTime" data-testid="alltime-tab">All-Time</button>
    </div>

    <div class="leaderboard-list" data-testid="leaderboard-list">
        @if (isLoading)
        {
            <p class="loading">Loading</p>
        }
        else if (entries == null || entries.Count == 0)
        {
            <p class="empty-message">@EmptyMessage</p>
        }
        else
        {
            @foreach (var entry in entries)
            {
                <div class="leaderboard-entry @GetHighlightClass(entry)">
                    <span class="rank @GetRankClass(entry.Rank)">#@entry.Rank</span>
                    <span class="nickname">@entry.Nickname</span>
                    <span class="score">@entry.AverageMs.ToString("F2")ms</span>
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter]
    public string? HighlightNickname { get; set; }

    private bool showDaily = false;
    private bool isLoading = true;
    private List<LeaderboardEntryDto>? entries;

    private string EmptyMessage => showDaily
        ? "No scores today. Be the first!"
        : "No scores yet. Be the first!";

    protected override async Task OnInitializedAsync()
    {
        await LoadAllTime();
    }

    private async Task ShowDaily()
    {
        showDaily = true;
        await LoadDaily();
    }

    private async Task ShowAllTime()
    {
        showDaily = false;
        await LoadAllTime();
    }

    private async Task LoadDaily()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<LeaderboardResponse>("/api/leaderboard/daily");
            entries = response?.Entries ?? new List<LeaderboardEntryDto>();
        }
        catch
        {
            entries = new List<LeaderboardEntryDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadAllTime()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<LeaderboardResponse>("/api/leaderboard/alltime");
            entries = response?.Entries ?? new List<LeaderboardEntryDto>();
        }
        catch
        {
            entries = new List<LeaderboardEntryDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    public async Task RefreshAsync()
    {
        if (showDaily)
            await LoadDaily();
        else
            await LoadAllTime();
    }

    private string GetRankClass(int rank) => rank switch
    {
        1 => "rank-1",
        2 => "rank-2",
        3 => "rank-3",
        _ => ""
    };

    private string GetHighlightClass(LeaderboardEntryDto entry)
    {
        return entry.Nickname == HighlightNickname ? "highlighted" : "";
    }
}
